- name: Create MongoDB data/log directories
  file:
    path: "{{ item }}"
    state: directory
    owner: mongodb
    group: mongodb
    mode: "0755"
  loop:
    - "{{ mongo_data_dir }}"
    - "{{ mongo_log_dir }}"
    - "{{ mongo_conf_dir }}"

- name: Disable transparent hugepage defragmentation
  become: true
  shell: |
    echo 'defer+madvise' > /sys/kernel/mm/transparent_hugepage/defrag

- name: Disable transparent hugepage paging
  become: true
  shell: |
    echo '0' > /sys/kernel/mm/transparent_hugepage/khugepaged/max_ptes_none

- name: Tune vm.swappiness to 1 (avoid swapping)
  become: true
  sysctl:
    name: vm.swappiness
    value: 1
    sysctl_set: yes
    state: present
    reload: yes

- name: Render mongod shard “auth” config file
  template:
    src: mongod.conf.j2
    dest: "{{ mongo_conf_dir }}/mongod.conf"
    owner: mongodb
    group: mongodb
    mode: "0644"

- name: Create systemd service file for MongoDB shard server
  copy:
    dest: /etc/systemd/system/mongod-shardsvr.service
    content: |
      [Unit]
      Description=MongoDB Shard Server
      After=network.target

      [Service]
      Type=simple
      User=mongodb
      Group=mongodb
      WorkingDirectory=/mnt/mongo
      LimitNOFILE=64000
      Environment=GLIBC_TUNABLES=glibc.pthread.rseq=0
      ExecStart={{ mongo_bin }}/mongod \
        --config "{{ mongo_conf_dir }}/mongod.conf"
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
  notify:
    - Reload systemd

- name: Enable and start MongoDB shard server service
  systemd:
    name: mongod-shardsvr.service
    enabled: yes
    state: started

- name: Fix ownership of all MongoDB files
  become: true
  file:
    path: /mnt/mongo
    recurse: yes
    owner: mongodb
    group: mongodb
  notify:
    - Reload systemd

- name: Wait for MongoDB port to be open
  wait_for:
    host: localhost
    port: "{{ shard_port }}"
    timeout: 60
    delay: 5
